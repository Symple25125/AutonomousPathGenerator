<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Build Path</title>
</head>
<body>
    <div id="app">
        <div class="point-settings">
            <h1>Point Settings</h1>
            <br>
            <p id="id-text">ID: ----</p>
            <br>
            <label>X:</label>
            <input id="settings-x" onchange="updateXSetting()" type="number" placeholder="X">
            <label>Y:</label>
            <input id="settings-y" onchange="updateYSetting()" type="number" placeholder="Y">
            <br>
            <label>Connected To: </label>
            <input id="settings-connection" type="text" onchange="updateConnectionSetting()" placeholder="Point ID">
        </div>
        <div class="centerstage">
            <canvas id="screen">
        </div>
    </div>

    <script src="/scripts/main.js"></script>
    <script>
        const canvas = document.getElementById("screen")
        const xSetting = document.getElementById("settings-x")
        const ySetting = document.getElementById("settings-y")
        const connectionSetting = document.getElementById("settings-connection")
        const idText = document.getElementById("id-text")

        const ctx = canvas.getContext("2d")

        const calcUnits = () => 60.96 / (canvas.getBoundingClientRect().width / 6);
        let cmPerPixel = calcUnits()

        const updateCanvasSize = () => {
            ctx.canvas.width = canvas.getBoundingClientRect().width
            ctx.canvas.height = canvas.getBoundingClientRect().height
        }
        
        updateCanvasSize()
        
        window.addEventListener("resize", () => {
            cmPerPixel = calcUnits()
            updateCanvasSize()
        })

        let selectedPoint = null;

        const pointRadius = 5

        const centerStageImage = new Image(30, 30)
        centerStageImage.src = "/centerstage.webp"

        let points = []

        const updateSettings = () => {
            console.log(selectedPoint)
            xSetting.value = selectedPoint.pos.x
            ySetting.value = selectedPoint.pos.y
            connectionSetting.value = selectedPoint.connection
            idText.innerHTML = `ID: ${selectedPoint.id}`
        }

        const selectPoint = (point) => {
            selectedPoint = point
            updateSettings()
        }

        canvas.addEventListener("click", (event) => {
            let xPos = event.x - canvas.getBoundingClientRect().x
            let yPos = event.y - canvas.getBoundingClientRect().y

            console.log(`xy: ${xPos}, ${yPos}`)
            console.log(`cm xy: ${xPos * cmPerPixel}, ${yPos * cmPerPixel}`)

            for(const p of points) {
                if(p.calcDist(new Vec2d(xPos, yPos)) <= pointRadius) {
                    selectPoint(p)
                    return;
                }
            }
            
            let point = new Point(xPos * cmPerPixel, yPos * cmPerPixel, genUUID());
            selectPoint(point);
            points.push(point)
        })

        canvas.addEventListener("contextmenu", (event) => {
            let xPos = event.x - canvas.getBoundingClientRect().x
            let yPos = event.y - canvas.getBoundingClientRect().y

            for(const p of points) {
                if(p.calcDist(new Vec2d(xPos, yPos)) <= pointRadius) {
                    const index = points.findIndex(pt => pt.id == p.id);
                    if (index > -1) {
                        points.splice(index, 1);
                        event.preventDefault()
                    }
                    return;
                }
            }
        })

        function draw() {
            ctx.drawImage(centerStageImage, 0, 0, ctx.canvas.width, ctx.canvas.height)
            
            let lineQueue = []
            let pointQueue = []

            for(const p of points) {
                const pos = p.getPosAsPixel()
                const c = selectedPoint == p ? "#ff00ff" : "#9900ff"
                pointQueue.push(new Circle(pos.x, pos.y, pointRadius, c))

                let connectionPoint = points.find(pt => pt.id == p.connection)
                if(connectionPoint != null) {
                    const cpPos = connectionPoint.getPosAsPixel()

                    lineQueue.push(new Line(pos, cpPos, selectedPoint == p ? "#550099" : "#9900ee", 5))
                }
            } 

            for(const line of lineQueue) {
                drawLine(ctx, line.from, line.to, line.color, line.width)
            }

            for(const point of pointQueue) {
                drawCircle(ctx, point.x, point.y, point.radius, point.color, 0, point.color)
            }

            requestAnimationFrame(draw)
        }

        requestAnimationFrame(draw)


        function drawCircle(context, x, y, radius, fillColor, strokeWidth, strokeColor) {
            context.beginPath();
            context.arc(x, y, radius, 0, 2 * Math.PI, false);
            context.fillStyle = fillColor;
            context.fill();
            context.lineWidth = strokeWidth;
            context.strokeStyle = strokeColor;
            context.stroke();
        }

        function drawLine(context, from, to, color, width) {
            context.beginPath();
            context.moveTo(from.x, from.y);
            context.lineTo(to.x, to.y);
            context.lineWidth = width;
            context.strokeStyle = color;
            context.stroke();
        }

        function updateXSetting() {
            selectedPoint.pos.x = xSetting.value;
        }

        function updateYSetting() {
            selectedPoint.pos.y = ySetting.value
        }

        function updateConnectionSetting() {
            selectedPoint.connection = connectionSetting.value
        }

        function genUUID() {
            let s = "abcdefghijklmnopqrstuvwxyz1234567890"
            
            let emptyString = ""
            for(let i = 0; i < 4; i++) {
                emptyString += s[Math.floor(Math.random() * s.length)];
            }

            if(points.some(p => p.id == emptyString)) return genUUID()
            return emptyString;
        }

        class Point {
            constructor(x, y, id, connection=null) {
                this.pos = new Vec2d(x, y)
                this.id = id
                this.connection = connection
            }

            getPosAsPixel() {
                return new Vec2d(this.pos.x / cmPerPixel, this.pos.y / cmPerPixel)
            }

            calcDist(p) {
                let pos = this.getPosAsPixel()
                return Math.sqrt(Math.pow(pos.x - p.x, 2), Math.pow(pos.y - p.y, 2))
            }
        }

        class Line {
            constructor(from, to, color, width) {
                this.from = from;
                this.to = to;
                this.color = color;
                this.width = width;
            }
        }
        
        class Circle {
            constructor(x, y, radius, color) {
                this.x = x;
                this.y = y;
                this.radius = radius;
                this.color = color;
            }
        }

        class Vec2d {
            constructor(x, y) {
                this.x = x
                this.y = y
            }
        }
    </script>
</body>
</html>